<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gridstack.js React integration example</title>
  <link rel="stylesheet" href="demo.css" />
  <link rel="stylesheet" href="../dist/gridstack.css" />
  <link rel="stylesheet" href="../dist/gridstack-extra.css" />
  <script src="../dist/gridstack-all.js"></script>

  <!-- Scripts to use react inside html - DEVELOPMENT FILES -->
  <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.js"></script>
</head>

<body>
  <div>
    <h2>Controlled stack</h2>
    <div id="controlled-stack"></div>
  </div>

  <script type="text/babel">

    const { useState, useEffect, useLayoutEffect, createRef, useRef } = React
    const Item = ({ id, isCollapsible }) => (
      <div style={{ display: 'flex', flexDirection: 'column' }}>
        <div style={{ flexGrow: '1' }}>{id}</div>
        {isCollapsible && (
          <div>
            <button>Show more</button>
          </div>
        )}
      </div>)

    const ControlledStack = ({ items, addItem, changeItems }) => {
      const refs = useRef({})
      const gridRef = useRef()
      const gridContainerRef = useRef(null)
      refs.current = {}

      if (Object.keys(refs.current).length !== items.length) {
        items.forEach(({ id }) => {
          refs.current[id] = refs.current[id] || createRef()
        })
      }

      useEffect(() => {
        if (!gridRef.current) {
          gridRef.current = GridStack.init(
            {
              float: false,
              acceptWidgets: true,
              minRow: 1,
            },
            gridContainerRef.current
          );
          gridRef.current.on('added', (ev, gsItems) => {
            if (gridRef.current._ignoreCB) return;
            gsItems.forEach(n => {
              gridRef.current.removeWidget(n.el, true, false); // true=remove DOM, false=don't call use back!
              addItem({ id: n.id, x: n.x, y: n.y, w: n.w, h: n.h });
            });
          });
          gridRef.current.on('removed change', (ev, gsItems) => {
            const newItems = gridRef.current.save(false); // saveContent=false
            changeItems(newItems);
          })
        }
      }, [addItem, changeItems])

      useEffect(() => {
        if (gridRef.current) {
          gridRef.current;
          const layout = items.map((a) =>
            ({ ...a, el: refs.current[a.id].current })
          );
          gridRef.current._ignoreCB = true;
          gridRef.current.load(layout);
          delete gridRef.current._ignoreCB;

        }

      }, [items]);



      return (
        <div style={{ width: '100%', marginRight: '10px' }}>
          <div className="grid-stack" ref={gridContainerRef}>
            {items.map((item) => {
              return (
                <div ref={refs.current[item.id]} key={item.id} className="grid-stack-item" gs-id={item.id}>
                  <div className="grid-stack-item-content">
                    <Item {...item} />
                  </div>
                </div>
              )
            })}
          </div>
          <code>
            <pre>{JSON.stringify(items, null, 2)}</pre>
          </code>
        </div>
      )
    }

    const initial = [
      { id: '1', x: 0, y: 0, w: 12, h: 1 },
      { id: '2', x: 0, y: 1, w: 12, h: 1 },
      { id: '3', x: 0, y: 2, w: 12, h: 1 },
      { id: '4', x: 0, y: 3, w: 12, h: 1 },
    ]

    const ControlledExample = () => {
      const [items1, setItems1] = useState(initial)
      const [isCollapsed, setCollapsed] = useState(false)
      const handleCollapse = () => {
        if (isCollapsed) {
          setItems1(prev => prev.map((item, index) => {
            if (index === 0) {
              return { ...item, h: 1 };
            }

            return item
          }));
          setCollapsed(false);
        } else {
          setItems1(prev => prev.map((item, index) => {
            if (index === 0) {
              return { ...item, h: 5 };
            }

            return item
          }));
          setCollapsed(true);

        }
      }



      return (
        <div>
          <div style={{ display: 'flex', gap: '16px', marginBottom: '16px' }}>
            <div>
              <button onClick={handleCollapse}>{isCollapsed ? 'Reduce 1' : 'Increase 1'}</button>
            </div>
          </div>

          <div style={{ display: 'flex' }}>
            <div style={{ display: 'flex', width: '100%' }}>
              <ControlledStack
                items={items1}
                addItem={(item) => {
                  setItems1(items => [...items, item])
                }}
                changeItems={(items) => setItems1(items)}
              />
            </div >
          </div >
        </div>
      )
    }

    ReactDOM.render(<ControlledExample />, document.getElementById('controlled-stack'))
  </script>
</body>

</html>