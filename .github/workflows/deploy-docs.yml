name: Deploy Documentation

on:
  push:
    branches: [ master ]
  # Allow manual triggering
  workflow_dispatch:

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    # Only run on pushes to master (not PRs)
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'

    - name: Install main dependencies
      run: yarn install

    - name: Install Angular dependencies
      run: |
        cd angular
        yarn install

    - name: Build Angular library
      run: yarn build:ng

    - name: Build main library
      run: |
        grunt
        webpack
        tsc --project tsconfig.docs.json --stripInternal

    - name: Generate all documentation
      run: yarn doc

    - name: Prepare deployment structure
      run: |
        mkdir -p deploy
        
        # Create proper directory structure for GitHub Pages
        mkdir -p deploy/doc/html
        mkdir -p deploy/angular/doc/html
        
        # Debug: Check what was generated
        echo "üìÅ Checking generated documentation..."
        echo "Main library HTML docs:"
        if [ -d "doc/html" ]; then
          echo "  ‚úì doc/html/ exists"
          ls -la doc/html/ | head -10
        else
          echo "  ‚úó doc/html/ NOT FOUND"
        fi
        
        echo "Angular library HTML docs:"
        if [ -d "angular/doc/html" ]; then
          echo "  ‚úì angular/doc/html/ exists"
          ls -la angular/doc/html/ | head -10
        else
          echo "  ‚úó angular/doc/html/ NOT FOUND"
        fi
        
        echo "Angular library Markdown docs (should NOT be deployed):"
        if [ -d "angular/doc/api" ]; then
          echo "  ‚ö† angular/doc/api/ exists (will NOT be copied to deployment)"
          ls -la angular/doc/api/ | head -10
        else
          echo "  ‚úì angular/doc/api/ does not exist"
        fi
        
        # Copy main library HTML documentation
        if [ -d "doc/html" ]; then
          cp -r doc/html/* deploy/doc/html/
          echo "‚úì Copied main library HTML docs"
        else
          echo "‚ö† Warning: Main library HTML docs not found, skipping..."
        fi
        
        # Copy Angular library HTML documentation  
        if [ -d "angular/doc/html" ]; then
          cp -r angular/doc/html/* deploy/angular/doc/html/
          echo "‚úì Copied Angular library HTML docs"
        else
          echo "‚ö† Warning: Angular library HTML docs not found, skipping..."
        fi
        
        # Note: Do NOT copy or create index.html at root
        # The gh-pages branch has its own index.html that should be preserved
        # The keep_files: true option will preserve existing files on gh-pages
        
        # Ensure .nojekyll exists to prevent Jekyll processing
        touch deploy/.nojekyll
        
        # Final verification
        echo ""
        echo "üì¶ Deployment structure:"
        find deploy -type f -name "*.html" | head -20

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./deploy
        keep_files: true
        commit_message: 'Deploy documentation from ${{ github.sha }}'
