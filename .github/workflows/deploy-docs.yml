name: Deploy Documentation

on:
  push:
    branches: [ master ]
  # Allow manual triggering
  workflow_dispatch:

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    # Only run on pushes to master (not PRs)
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'

    - name: Install main dependencies
      run: yarn install

    - name: Install Angular dependencies
      run: |
        cd angular
        yarn install

    - name: Build Angular library
      run: yarn build:ng

    - name: Build main library
      run: |
        grunt
        webpack
        tsc --project tsconfig.docs.json --stripInternal

    - name: Generate all documentation
      run: yarn doc

    - name: Prepare deployment structure
      run: |
        mkdir -p deploy
        
        # Create proper directory structure for GitHub Pages
        mkdir -p deploy/doc/html
        mkdir -p deploy/angular/doc/html
        
        # Debug: Check what was generated
        echo "ðŸ“ Checking generated documentation..."
        echo "Main library HTML docs:"
        if [ -d "doc/html" ]; then
          echo "  âœ“ doc/html/ exists"
          ls -la doc/html/ | head -10
        else
          echo "  âœ— doc/html/ NOT FOUND"
        fi
        
        echo "Angular library HTML docs:"
        if [ -d "angular/doc/html" ]; then
          echo "  âœ“ angular/doc/html/ exists"
          ls -la angular/doc/html/ | head -10
        else
          echo "  âœ— angular/doc/html/ NOT FOUND"
        fi
        
        echo "Angular library Markdown docs (should NOT be deployed):"
        if [ -d "angular/doc/api" ]; then
          echo "  âš  angular/doc/api/ exists (will NOT be copied to deployment)"
          ls -la angular/doc/api/ | head -10
        else
          echo "  âœ“ angular/doc/api/ does not exist"
        fi
        
        # Copy main library HTML documentation
        if [ -d "doc/html" ]; then
          cp -r doc/html/* deploy/doc/html/
          echo "âœ“ Copied main library HTML docs"
        else
          echo "âš  Warning: Main library HTML docs not found, skipping..."
        fi
        
        # Copy Angular library HTML documentation  
        if [ -d "angular/doc/html" ]; then
          cp -r angular/doc/html/* deploy/angular/doc/html/
          echo "âœ“ Copied Angular library HTML docs"
        else
          echo "âš  Warning: Angular library HTML docs not found, skipping..."
        fi
        
        # Note: Do NOT copy or create index.html at root
        # The gh-pages branch has its own index.html that should be preserved
        # The keep_files: true option will preserve existing files on gh-pages
        
        # Ensure .nojekyll exists to prevent Jekyll processing
        touch deploy/.nojekyll
        
        # Final verification
        echo ""
        echo "ðŸ“¦ Deployment structure:"
        find deploy -type f -name "*.html" | head -20
    
    - name: Preserve gh-pages root index.html
      run: |
        # Fetch gh-pages to get existing index.html if we didn't create one
        if [ ! -f "deploy/index.html" ]; then
          echo "ðŸ“„ No index.html in deploy, fetching from gh-pages..."
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          
          # Check out just the index.html from gh-pages if it exists
          if git show origin/gh-pages:index.html > /dev/null 2>&1; then
            git show origin/gh-pages:index.html > deploy/index.html
            echo "âœ“ Preserved existing index.html from gh-pages"
          else
            echo "â„¹ No index.html on gh-pages to preserve"
          fi
        else
          echo "â„¹ index.html already in deploy directory, not fetching from gh-pages"
        fi

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./deploy
        # Force clean deployment - creates orphan branch to remove ALL old files
        force_orphan: true
        commit_message: 'Deploy documentation from ${{ github.sha }}'
