(function(e){if(typeof define==="function"&&define.amd){define(["jquery","underscore","jqueryui"],e)}else{e(jQuery,_)}})(function(e,t){var n=window;var r={is_intercepted:function(e,t){return!(e.x+e.width<=t.x||t.x+t.width<=e.x||e.y+e.height<=t.y||t.y+t.height<=e.y)},sort:function(e,n,r){r=r||t.chain(e).map(function(e){return e.x+e.width}).max().value();n=n!=-1?1:-1;return t.sortBy(e,function(e){return n*(e.x+e.y*r)})},create_stylesheet:function(){var e=document.createElement("style");e.setAttribute("type","text/css");var t="";if(e.styleSheet){e.styleSheet.cssText=t}else{e.appendChild(document.createTextNode(t))}document.getElementsByTagName("head")[0].appendChild(e);if(e.styleSheet)return e.styleSheet;else return e.sheet},toBool:function(e){if(typeof e=="boolean")return e;if(typeof e=="string"){e=e.toLowerCase();return!(e==""||e=="no"||e=="false"||e=="0")}return Boolean(e)}};var i=0;var s=function(e,t,n,r,i){this.width=e;this.float=n||false;this.height=r||0;this.nodes=i||[];this.onchange=t||function(){}};s.prototype._fix_collisions=function(e){this._sort_nodes(-1);while(true){var n=t.find(this.nodes,function(t){return t!=e&&r.is_intercepted(t,e)},this);if(typeof n=="undefined"){return}this.move_node(n,n.x,e.y+e.height,n.width,n.height,true)}};s.prototype._sort_nodes=function(e){this.nodes=r.sort(this.nodes,e,this.width)};s.prototype._pack_nodes=function(){this._sort_nodes();if(this.float){t.each(this.nodes,function(e,n){if(e._updating||typeof e._orig_y=="undefined"||e.y==e._orig_y)return;var i=e.y;while(i>=e._orig_y){var s=t.chain(this.nodes).find(function(t){return e!=t&&r.is_intercepted({x:e.x,y:i,width:e.width,height:e.height},t)}).value();if(!s){e._dirty=true;e.y=i}--i}},this)}else{t.each(this.nodes,function(e,n){if(e.locked)return;while(e.y>0){var i=e.y-1;var s=n==0;if(n>0){var o=t.chain(this.nodes).first(n).find(function(t){return r.is_intercepted({x:e.x,y:i,width:e.width,height:e.height},t)}).value();s=typeof o=="undefined"}if(!s){break}e._dirty=e.y!=i;e.y=i}},this)}};s.prototype._prepare_node=function(e,n){e=t.defaults(e||{},{width:1,height:1,x:0,y:0});e.x=parseInt(""+e.x);e.y=parseInt(""+e.y);e.width=parseInt(""+e.width);e.height=parseInt(""+e.height);e.auto_position=e.auto_position||false;e.no_resize=e.no_resize||false;e.no_move=e.no_move||false;if(e.width>this.width){e.width=this.width}else if(e.width<1){e.width=1}if(e.height<1){e.height=1}if(e.x<0){e.x=0}if(e.x+e.width>this.width){if(n){e.width=this.width-e.x}else{e.x=this.width-e.width}}if(e.y<0){e.y=0}return e};s.prototype._notify=function(){var e=Array.prototype.slice.call(arguments,1).concat(this.get_dirty_nodes());e=e.concat(this.get_dirty_nodes());this.onchange(e)};s.prototype.clean_nodes=function(){t.each(this.nodes,function(e){e._dirty=false})};s.prototype.get_dirty_nodes=function(){return t.filter(this.nodes,function(e){return e._dirty})};s.prototype.add_node=function(e){e=this._prepare_node(e);if(typeof e.max_width!="undefined")e.width=Math.min(e.width,e.max_width);if(typeof e.max_height!="undefined")e.height=Math.min(e.height,e.max_height);if(typeof e.min_width!="undefined")e.width=Math.max(e.width,e.min_width);if(typeof e.min_height!="undefined")e.height=Math.max(e.height,e.min_height);e._id=++i;e._dirty=true;if(e.auto_position){this._sort_nodes();for(var n=0;;++n){var s=n%this.width,o=Math.floor(n/this.width);if(s+e.width>this.width){continue}if(!t.find(this.nodes,function(t){return r.is_intercepted({x:s,y:o,width:e.width,height:e.height},t)})){e.x=s;e.y=o;break}}}this.nodes.push(e);this._fix_collisions(e);this._pack_nodes();this._notify();return e};s.prototype.remove_node=function(e){e._id=null;this.nodes=t.without(this.nodes,e);this._pack_nodes();this._notify(e)};s.prototype.can_move_node=function(n,r,i,o,u){var a=Boolean(t.find(this.nodes,function(e){return e.locked}));if(!this.height&&!a)return true;var f;var l=new s(this.width,null,this.float,0,t.map(this.nodes,function(t){if(t==n){f=e.extend({},t);return f}return e.extend({},t)}));l.move_node(f,r,i,o,u);var c=true;if(a)c&=!Boolean(t.find(l.nodes,function(e){return e!=f&&Boolean(e.locked)&&Boolean(e._dirty)}));if(this.height)c&=l.get_grid_height()<=this.height;return c};s.prototype.can_be_placed_with_respect_to_height=function(n){if(!this.height)return true;var r=new s(this.width,null,this.float,0,t.map(this.nodes,function(t){return e.extend({},t)}));r.add_node(n);return r.get_grid_height()<=this.height};s.prototype.move_node=function(e,t,n,r,i,s){if(typeof t!="number")t=e.x;if(typeof n!="number")n=e.y;if(typeof r!="number")r=e.width;if(typeof i!="number")i=e.height;if(typeof e.max_width!="undefined")r=Math.min(r,e.max_width);if(typeof e.max_height!="undefined")i=Math.min(i,e.max_height);if(typeof e.min_width!="undefined")r=Math.max(r,e.min_width);if(typeof e.min_height!="undefined")i=Math.max(i,e.min_height);if(e.x==t&&e.y==n&&e.width==r&&e.height==i){return e}var o=e.width!=r;e._dirty=true;e.x=t;e.y=n;e.width=r;e.height=i;e=this._prepare_node(e,o);this._fix_collisions(e);if(!s){this._pack_nodes();this._notify()}return e};s.prototype.get_grid_height=function(){return t.reduce(this.nodes,function(e,t){return Math.max(e,t.y+t.height)},0)};s.prototype.begin_update=function(e){t.each(this.nodes,function(e){e._orig_y=e.y});e._updating=true};s.prototype.end_update=function(){var e=t.find(this.nodes,function(e){return e._updating});if(e){e._updating=false}};var o=function(n,i){var o=this,u;this.container=e(n);this.opts=t.defaults(i||{},{width:parseInt(this.container.attr("data-gs-width"))||12,height:parseInt(this.container.attr("data-gs-height"))||0,item_class:"grid-stack-item",placeholder_class:"grid-stack-placeholder",handle:".grid-stack-item-content",cell_height:60,vertical_margin:20,auto:true,min_width:768,"float":false,_class:"grid-stack-"+(Math.random()*1e4).toFixed(0),animate:Boolean(this.container.attr("data-gs-animate"))||false});this.container.addClass(this.opts._class);this._styles=r.create_stylesheet();this._styles._max=0;this.grid=new s(this.opts.width,function(e){var n=0;t.each(e,function(e){if(e._id==null){e.el.remove()}else{e.el.attr("data-gs-x",e.x).attr("data-gs-y",e.y).attr("data-gs-width",e.width).attr("data-gs-height",e.height);n=Math.max(n,e.y+e.height)}});o._update_styles(n+10)},this.opts.float,this.opts.height);if(this.opts.auto){this.container.find("."+this.opts.item_class).each(function(e,t){o._prepare_element(t)})}this.set_animation(this.opts.animate);this.placeholder=e('<div class="'+this.opts.placeholder_class+" "+this.opts.item_class+'"><div class="placeholder-content" /></div>').hide();this.container.append(this.placeholder);this.container.height(this.grid.get_grid_height()*(this.opts.cell_height+this.opts.vertical_margin)-this.opts.vertical_margin);var a=function(){if(o._is_one_column_mode()){if(u)return;u=true;t.each(o.grid.nodes,function(e){if(!e.no_move){e.el.draggable("disable")}if(!e.no_resize){e.el.resizable("disable")}})}else{if(!u)return;u=false;t.each(o.grid.nodes,function(e){if(!e.no_move){e.el.draggable("enable")}if(!e.no_resize){e.el.resizable("enable")}})}};e(window).resize(a);a()};o.prototype._update_styles=function(e){if(typeof e=="undefined"){e=this._styles._max;this._styles._max=0;while(this._styles.rules.length){this._styles.removeRule(0)}this._update_container_height()}if(e>this._styles._max){for(var t=this._styles._max;t<e;++t){var n="."+this.opts._class+" ."+this.opts.item_class+'[data-gs-height="'+(t+1)+'"]';var r="height: "+(this.opts.cell_height*(t+1)+this.opts.vertical_margin*t)+"px;";if(this._styles.insertRule){this._styles.insertRule(n+"{"+r+"}",t)}else{this._styles.addRule(n,r,t)}n="."+this.opts._class+" ."+this.opts.item_class+'[data-gs-y="'+t+'"]';r="top: "+(this.opts.cell_height*t+this.opts.vertical_margin*t)+"px; ";if(this._styles.insertRule){this._styles.insertRule(n+"{"+r+"}",t)}else{this._styles.addRule(n,r,t)}}this._styles._max=e}};o.prototype._update_container_height=function(){this.container.height(this.grid.get_grid_height()*(this.opts.cell_height+this.opts.vertical_margin)-this.opts.vertical_margin)};o.prototype._is_one_column_mode=function(){return e(window).width()<=this.opts.min_width};o.prototype._prepare_element=function(n){var i=this;n=e(n);n.addClass(this.opts.item_class);var s=i.grid.add_node({x:n.attr("data-gs-x"),y:n.attr("data-gs-y"),width:n.attr("data-gs-width"),height:n.attr("data-gs-height"),max_width:n.attr("data-gs-max-width"),min_width:n.attr("data-gs-min-width"),max_height:n.attr("data-gs-max-height")||100,min_height:n.attr("data-gs-min-height"),auto_position:r.toBool(n.attr("data-gs-auto-position")),no_resize:r.toBool(n.attr("data-gs-no-resize")),no_move:r.toBool(n.attr("data-gs-no-move")),locked:r.toBool(n.attr("data-gs-locked")),el:n});n.data("_gridstack_node",s);var o,u;var a=function(t,n){var r=e(this);i.grid.clean_nodes();i.grid.begin_update(s);o=Math.ceil(r.outerWidth()/r.attr("data-gs-width"));u=i.opts.cell_height+i.opts.vertical_margin;i.placeholder.attr("data-gs-x",r.attr("data-gs-x")).attr("data-gs-y",r.attr("data-gs-y")).attr("data-gs-width",r.attr("data-gs-width")).attr("data-gs-height",r.attr("data-gs-height")).show();s.el=i.placeholder};var f=function(n,r){var o=e(this);s.el=o;i.placeholder.hide();o.attr("data-gs-x",s.x).attr("data-gs-y",s.y).attr("data-gs-width",s.width).attr("data-gs-height",s.height).removeAttr("style");i._update_container_height();i.container.trigger("change",[i.grid.get_dirty_nodes()]);i.grid.end_update();i.grid._sort_nodes();setTimeout(function(){t.each(i.grid.nodes,function(e){e.el.detach();i.container.append(e.el)})},i.opts.animate?300:0)};n.draggable({handle:this.opts.handle,scroll:true,appendTo:"body",start:a,stop:f,drag:function(e,t){var n=Math.round(t.position.left/o),r=Math.floor((t.position.top+u/2)/u);if(!i.grid.can_move_node(s,n,r,s.width,s.height)){return}i.grid.move_node(s,n,r);i._update_container_height()}}).resizable({autoHide:true,handles:"se",minHeight:this.opts.cell_height-10,minWidth:70,start:a,stop:f,resize:function(e,t){var n=Math.round(t.size.width/o),r=Math.round(t.size.height/u);if(!i.grid.can_move_node(s,s.x,s.y,n,r)){return}i.grid.move_node(s,s.x,s.y,n,r);i._update_container_height()}});if(s.no_move||this._is_one_column_mode()){n.draggable("disable")}if(s.no_resize||this._is_one_column_mode()){n.resizable("disable")}n.attr("data-gs-locked",s.locked?"yes":null)};o.prototype.set_animation=function(e){if(e){this.container.addClass("grid-stack-animate")}else{this.container.removeClass("grid-stack-animate")}};o.prototype.add_widget=function(t,n,r,i,s,o){t=e(t);if(typeof n!="undefined")t.attr("data-gs-x",n);if(typeof r!="undefined")t.attr("data-gs-y",r);if(typeof i!="undefined")t.attr("data-gs-width",i);if(typeof s!="undefined")t.attr("data-gs-height",s);if(typeof o!="undefined")t.attr("data-gs-auto-position",o?"yes":null);this.container.append(t);this._prepare_element(t);this._update_container_height()};o.prototype.will_it_fit=function(e,t,n,r,i){var s={x:e,y:t,width:n,height:r,auto_position:i};return this.grid.can_be_placed_with_respect_to_height(s)};o.prototype.remove_widget=function(t){t=e(t);var n=t.data("_gridstack_node");this.grid.remove_node(n);t.remove();this._update_container_height()};o.prototype.remove_all=function(){t.each(this.grid.nodes,function(e){e.el.remove()});this.grid.nodes=[];this._update_container_height()};o.prototype.resizable=function(t,n){t=e(t);t.each(function(t,r){r=e(r);var i=r.data("_gridstack_node");if(typeof i=="undefined"){return}i.no_resize=!(n||false);if(i.no_resize){r.resizable("disable")}else{r.resizable("enable")}});return this};o.prototype.movable=function(t,n){t=e(t);t.each(function(t,r){r=e(r);var i=r.data("_gridstack_node");if(typeof i=="undefined"){return}i.no_move=!(n||false);if(i.no_move){r.draggable("disable")}else{r.draggable("enable")}});return this};o.prototype.locked=function(t,n){t=e(t);t.each(function(t,r){r=e(r);var i=r.data("_gridstack_node");if(typeof i=="undefined"){return}i.locked=n||false;r.attr("data-gs-locked",i.locked?"yes":null)});return this};o.prototype._update_element=function(n,r){n=e(n).first();var i=n.data("_gridstack_node");if(typeof i=="undefined"){return}var s=this;s.grid.clean_nodes();s.grid.begin_update(i);r.call(this,n,i);s._update_container_height();s.container.trigger("change",[s.grid.get_dirty_nodes()]);s.grid.end_update();s.grid._sort_nodes();t.each(s.grid.nodes,function(e){e.el.detach();s.container.append(e.el)})};o.prototype.resize=function(e,t,n){this._update_element(e,function(e,r){t=t!=null&&typeof t!="undefined"?t:r.width;n=n!=null&&typeof n!="undefined"?n:r.height;this.grid.move_node(r,r.x,r.y,t,n)})};o.prototype.move=function(e,t,n){this._update_element(e,function(e,r){t=t!=null&&typeof t!="undefined"?t:r.x;n=n!=null&&typeof n!="undefined"?n:r.y;this.grid.move_node(r,t,n,r.width,r.height)})};o.prototype.cell_height=function(e){if(typeof e=="undefined"){return this.opts.cell_height}e=parseInt(e);if(e==this.opts.cell_height)return;this.opts.cell_height=e||this.opts.cell_height;this._update_styles()};o.prototype.cell_width=function(){var e=this.container.find("."+this.opts.item_class).first();return Math.ceil(e.outerWidth()/e.attr("data-gs-width"))};n.GridStackUI=o;n.GridStackUI.Utils=r;e.fn.gridstack=function(t){return this.each(function(){if(!e(this).data("gridstack")){e(this).data("gridstack",new o(this,t))}})}})
